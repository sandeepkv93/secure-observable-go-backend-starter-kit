openapi: 3.0.3
info:
  title: Everything Backend Starter Kit API
  version: 1.1.0
  description: Cookie-based auth with Google OAuth2 and local email/password auth, plus RBAC-protected admin endpoints. Error responses support envelope JSON by default and RFC7807 via Accept negotiation (`application/problem+json`).
servers:
  - url: http://localhost:8080/api/v1
tags:
  - name: Health
  - name: Auth
  - name: User
  - name: Products
  - name: Admin
components:
  securitySchemes:
    accessTokenCookie:
      type: apiKey
      in: cookie
      name: access_token
  parameters:
    IdempotencyKey:
      in: header
      name: Idempotency-Key
      required: true
      description: Unique request key used to deduplicate retried mutating requests.
      schema:
        type: string
        minLength: 1
        maxLength: 128
      example: 8f08db4b-3173-42f8-9bc2-c97d2229b3cb
  schemas:
    Meta:
      type: object
      required: [request_id, timestamp]
      properties:
        request_id:
          type: string
          example: req-abc123
        timestamp:
          type: string
          format: date-time
          example: "2026-02-09T10:00:00Z"

    APIError:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
          example: BAD_REQUEST
        message:
          type: string
          example: invalid payload
        details:
          type: object
          additionalProperties: true
          nullable: true

    ErrorEnvelope:
      type: object
      required: [success, error, meta]
      properties:
        success:
          type: boolean
          enum: [false]
        error:
          $ref: '#/components/schemas/APIError'
        meta:
          $ref: '#/components/schemas/Meta'

    ProblemDetails:
      type: object
      required: [type, title, status, detail, instance, code, request_id]
      properties:
        type:
          type: string
          example: urn:problem:everything-backend:bad-request
        title:
          type: string
          example: Bad Request
        status:
          type: integer
          format: int32
          example: 400
        detail:
          type: string
          example: invalid payload
        instance:
          type: string
          example: /api/v1/auth/local/login
        code:
          type: string
          example: BAD_REQUEST
        request_id:
          type: string
          example: req-abc123

    Envelope:
      type: object
      properties:
        success: { type: boolean }
        data: {}
        error: { $ref: '#/components/schemas/APIError' }
        meta: { $ref: '#/components/schemas/Meta' }

    PermissionSummary:
      type: object
      required: [id, resource, action, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
          example: 1
        resource:
          type: string
          example: users
        action:
          type: string
          example: read
        created_at:
          type: string
          format: date-time
          example: "2026-02-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-01T00:00:00Z"

    RoleSummary:
      type: object
      required: [id, name, description, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
          example: 2
        name:
          type: string
          minLength: 1
          maxLength: 64
          example: support_admin
        description:
          type: string
          maxLength: 255
          example: Support operators with user read/update access.
        permissions:
          type: array
          items:
            $ref: '#/components/schemas/PermissionSummary'
        created_at:
          type: string
          format: date-time
          example: "2026-02-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-01T00:00:00Z"

    UserSummary:
      type: object
      required: [id, email, name, status, last_login_at, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
          example: 42
        email:
          type: string
          format: email
          example: admin@example.com
        name:
          type: string
          example: Admin User
        avatar_url:
          type: string
          nullable: true
          example: https://cdn.example.com/avatars/42.png
        status:
          type: string
          example: active
        last_login_at:
          type: string
          format: date-time
          example: "2026-02-09T09:58:32Z"
        created_at:
          type: string
          format: date-time
          example: "2026-02-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-02-09T09:58:32Z"
        roles:
          type: array
          items:
            $ref: '#/components/schemas/RoleSummary'

    SetUserRolesRequest:
      type: object
      required: [role_ids]
      properties:
        role_ids:
          type: array
          minItems: 0
          uniqueItems: true
          items:
            type: integer
            format: uint64
      example:
        role_ids: [1, 2]

    SetUserRolesData:
      type: object
      required: [user_id, role_ids]
      properties:
        user_id:
          type: integer
          format: uint64
          example: 42
        role_ids:
          type: array
          items:
            type: integer
            format: uint64
          example: [1, 2]

    SetUserRolesResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/SetUserRolesData'
        meta:
          $ref: '#/components/schemas/Meta'

    CreateRoleRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 64
        description:
          type: string
          maxLength: 255
        permissions:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_\-]+:[a-zA-Z0-9_\-]+$'
      example:
        name: support_admin
        description: Support operators with user management capabilities
        permissions:
          - users:read
          - users:write

    UpdateRoleRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 64
        description:
          type: string
          maxLength: 255
        permissions:
          type: array
          items:
            type: string
            pattern: '^[a-zA-Z0-9_\-]+:[a-zA-Z0-9_\-]+$'
      example:
        name: support_admin_v2
        description: Updated description
        permissions:
          - users:read
          - users:write
          - roles:read

    CreatePermissionRequest:
      type: object
      required: [resource, action]
      properties:
        resource:
          type: string
          pattern: '^[a-zA-Z0-9_\-]+$'
          example: sessions
        action:
          type: string
          pattern: '^[a-zA-Z0-9_\-]+$'
          example: revoke

    UpdatePermissionRequest:
      type: object
      required: [resource, action]
      properties:
        resource:
          type: string
          pattern: '^[a-zA-Z0-9_\-]+$'
          example: sessions
        action:
          type: string
          pattern: '^[a-zA-Z0-9_\-]+$'
          example: revoke

    PaginationMeta:
      type: object
      required: [page, page_size, total, total_pages]
      properties:
        page:
          type: integer
          format: int32
          minimum: 1
          example: 1
        page_size:
          type: integer
          format: int32
          minimum: 1
          maximum: 100
          example: 20
        total:
          type: integer
          format: int64
          minimum: 0
          example: 52
        total_pages:
          type: integer
          format: int32
          minimum: 0
          example: 3

    UserListData:
      type: object
      required: [items, pagination]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/UserSummary'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    RoleListData:
      type: object
      required: [items, pagination]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/RoleSummary'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    PermissionListData:
      type: object
      required: [items, pagination]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PermissionSummary'
        pagination:
          $ref: '#/components/schemas/PaginationMeta'

    UserListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/UserListData'
        meta:
          $ref: '#/components/schemas/Meta'

    RoleListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/RoleListData'
        meta:
          $ref: '#/components/schemas/Meta'

    PermissionListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/PermissionListData'
        meta:
          $ref: '#/components/schemas/Meta'

    CreateRoleResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/RoleSummary'
        meta:
          $ref: '#/components/schemas/Meta'

    DeleteRoleResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          required: [role_id, status]
          properties:
            role_id:
              type: integer
              format: uint64
              example: 7
            status:
              type: string
              example: deleted
        meta:
          $ref: '#/components/schemas/Meta'

    DeletePermissionResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          required: [permission_id, status]
          properties:
            permission_id:
              type: integer
              format: uint64
              example: 13
            status:
              type: string
              example: deleted
        meta:
          $ref: '#/components/schemas/Meta'

    RBACSyncReport:
      type: object
      required: [created_permissions, created_roles, bound_permissions, noop]
      properties:
        created_permissions:
          type: integer
          format: int64
          example: 0
        created_roles:
          type: integer
          format: int64
          example: 0
        bound_permissions:
          type: integer
          format: int64
          example: 0
        noop:
          type: boolean
          example: true

    RBACSyncResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          $ref: '#/components/schemas/RBACSyncReport'
        meta:
          $ref: '#/components/schemas/Meta'

    SessionSummary:
      type: object
      required: [id, created_at, expires_at, user_agent, ip, is_current]
      properties:
        id:
          type: integer
          format: uint64
          example: 101
        created_at:
          type: string
          format: date-time
          example: "2026-02-09T10:00:00Z"
        expires_at:
          type: string
          format: date-time
          example: "2026-02-16T10:00:00Z"
        revoked_at:
          type: string
          format: date-time
          nullable: true
          example: null
        user_agent:
          type: string
          example: Mozilla/5.0
        ip:
          type: string
          example: 203.0.113.10
        is_current:
          type: boolean
          example: true

    SessionListResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: array
          items:
            $ref: '#/components/schemas/SessionSummary'
        meta:
          $ref: '#/components/schemas/Meta'

    RevokeSessionResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          required: [session_id, status]
          properties:
            session_id:
              type: integer
              format: uint64
              example: 101
            status:
              type: string
              example: revoked
        meta:
          $ref: '#/components/schemas/Meta'

    RevokeOtherSessionsResponse:
      type: object
      required: [success, data, meta]
      properties:
        success:
          type: boolean
          enum: [true]
        data:
          type: object
          required: [current_session_id, revoked_count]
          properties:
            current_session_id:
              type: integer
              format: uint64
              example: 101
            revoked_count:
              type: integer
              format: int64
              example: 2
        meta:
          $ref: '#/components/schemas/Meta'

    FeatureFlagRule:
      type: object
      required: [id, feature_flag_id, type, percentage, enabled, priority, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
        feature_flag_id:
          type: integer
          format: uint64
        type:
          type: string
          enum: [user, role, org, environment, percent]
        match_value:
          type: string
          nullable: true
        percentage:
          type: integer
          format: int32
          minimum: 0
          maximum: 100
        enabled:
          type: boolean
        priority:
          type: integer
          format: int32
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    FeatureFlag:
      type: object
      required: [id, key, enabled, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
        key:
          type: string
          example: new_checkout
        description:
          type: string
        enabled:
          type: boolean
        rules:
          type: array
          items:
            $ref: '#/components/schemas/FeatureFlagRule'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    FeatureFlagEvaluation:
      type: object
      required: [key, enabled, source]
      properties:
        key:
          type: string
        enabled:
          type: boolean
        source:
          type: string
          example: rule:role
        description:
          type: string

    FeatureFlagCreateRequest:
      type: object
      required: [key, enabled]
      properties:
        key:
          type: string
          pattern: '^[a-z0-9][a-z0-9_\-]{0,127}$'
        description:
          type: string
        enabled:
          type: boolean

    FeatureFlagUpdateRequest:
      type: object
      required: [key, enabled]
      properties:
        key:
          type: string
          pattern: '^[a-z0-9][a-z0-9_\-]{0,127}$'
        description:
          type: string
        enabled:
          type: boolean

    FeatureFlagRuleUpsertRequest:
      type: object
      required: [type, enabled]
      properties:
        type:
          type: string
          enum: [user, role, org, environment, percent]
        match_value:
          type: string
        percentage:
          type: integer
          format: int32
          minimum: 0
          maximum: 100
        enabled:
          type: boolean
        priority:
          type: integer
          format: int32

    Product:
      type: object
      required: [id, name, description, price, created_at, updated_at]
      properties:
        id:
          type: integer
          format: uint64
          minimum: 1
        name:
          type: string
          minLength: 3
          maxLength: 120
        description:
          type: string
          maxLength: 500
        price:
          type: number
          format: double
          exclusiveMinimum: 0
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ProductCreateRequest:
      type: object
      required: [name, price]
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 120
        description:
          type: string
          maxLength: 500
        price:
          type: number
          format: double
          exclusiveMinimum: 0

    ProductUpdateRequest:
      type: object
      minProperties: 1
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 120
        description:
          type: string
          maxLength: 500
        price:
          type: number
          format: double
          exclusiveMinimum: 0

  responses:
    BadRequestError:
      description: Request payload/path/query is invalid.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            invalidPayload:
              value:
                success: false
                error:
                  code: BAD_REQUEST
                  message: invalid payload
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    ConflictError:
      description: Request conflicts with existing state (for example, idempotency key replay mismatch).
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            conflict:
              value:
                success: false
                error:
                  code: CONFLICT
                  message: idempotency key reuse with different payload
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    UnauthorizedError:
      description: Authentication failed or access token is missing/invalid.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            unauthorized:
              value:
                success: false
                error:
                  code: UNAUTHORIZED
                  message: invalid credentials
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    ForbiddenError:
      description: Authenticated but missing required permission.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            forbidden:
              value:
                success: false
                error:
                  code: FORBIDDEN
                  message: missing permission users:write
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    NotFoundError:
      description: Resource was not found.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            notFound:
              value:
                success: false
                error:
                  code: NOT_FOUND
                  message: user not found
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
    InternalError:
      description: Unexpected server failure.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          examples:
            internal:
              value:
                success: false
                error:
                  code: INTERNAL
                  message: failed to list users
                meta:
                  request_id: req-abc123
                  timestamp: "2026-02-09T10:00:00Z"
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'

paths:
  /health/live:
    servers:
      - url: http://localhost:8080
    get:
      tags: [Health]
      summary: Liveness probe
      operationId: healthLive
      responses:
        '200':
          description: Service process is alive
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }

  /health/ready:
    servers:
      - url: http://localhost:8080
    get:
      tags: [Health]
      summary: Readiness probe
      operationId: healthReady
      responses:
        '200':
          description: Dependencies are ready
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '503':
          $ref: '#/components/responses/ServiceUnavailableError'

  /auth/google/login:
    get:
      tags: [Auth]
      summary: Start Google OAuth login
      operationId: authGoogleLogin
      responses:
        '302': { description: Redirect to Google }

  /auth/google/callback:
    get:
      tags: [Auth]
      summary: Handle Google OAuth callback
      operationId: authGoogleCallback
      parameters:
        - in: query
          name: code
          required: true
          schema: { type: string }
        - in: query
          name: state
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Login success
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/local/register:
    post:
      tags: [Auth]
      summary: Register local email/password account
      operationId: authLocalRegister
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, name, password]
              properties:
                email: { type: string, format: email }
                name: { type: string }
                password: { type: string, format: password, minLength: 12 }
      responses:
        '201':
          description: Local registration success
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '409':
          $ref: '#/components/responses/ConflictError'

  /auth/local/login:
    post:
      tags: [Auth]
      summary: Login with local email/password
      operationId: authLocalLogin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        '200':
          description: Local login success
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /auth/local/verify/request:
    post:
      tags: [Auth]
      summary: Request local email verification token
      operationId: authLocalVerifyRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email }
      responses:
        '202':
          description: Verification request accepted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /auth/local/verify/confirm:
    post:
      tags: [Auth]
      summary: Confirm local email verification token
      operationId: authLocalVerifyConfirm
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token]
              properties:
                token: { type: string }
      responses:
        '200':
          description: Email verified
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /auth/local/password/forgot:
    post:
      tags: [Auth]
      summary: Request local password reset token
      operationId: authLocalPasswordForgot
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email: { type: string, format: email }
      responses:
        '200':
          description: Request accepted with generic response
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '409':
          $ref: '#/components/responses/ConflictError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /auth/local/password/reset:
    post:
      tags: [Auth]
      summary: Reset local password using one-time token
      operationId: authLocalPasswordReset
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [token, new_password]
              properties:
                token: { type: string }
                new_password: { type: string, format: password, minLength: 12 }
      responses:
        '200':
          description: Password reset success
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /auth/local/change-password:
    post:
      tags: [Auth]
      summary: Change local account password
      operationId: authLocalChangePassword
      security:
        - accessTokenCookie: []
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [current_password, new_password]
              properties:
                current_password: { type: string, format: password }
                new_password: { type: string, format: password, minLength: 12 }
      responses:
        '200': { description: Password changed }
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Rotate refresh token and issue new access token
      operationId: authRefresh
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Token refresh success
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Revoke current user sessions
      operationId: authLogout
      security:
        - accessTokenCookie: []
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      responses:
        '200': { description: Logout success }
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /me:
    get:
      tags: [User]
      summary: Get current profile
      operationId: userMe
      security:
        - accessTokenCookie: []
      responses:
        '200':
          description: Profile
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Envelope' }
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /me/sessions:
    get:
      tags: [User]
      summary: List active sessions for current user
      operationId: userListSessions
      security:
        - accessTokenCookie: []
      responses:
        '200':
          description: Active sessions returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /me/sessions/{session_id}:
    delete:
      tags: [User]
      summary: Revoke a specific session/device
      operationId: userRevokeSession
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: session_id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Session revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokeSessionResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /me/sessions/revoke-others:
    post:
      tags: [User]
      summary: Revoke all active sessions except current one
      operationId: userRevokeOtherSessions
      security:
        - accessTokenCookie: []
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Other sessions revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokeOtherSessionsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /me/avatar:
    post:
      tags: [User]
      summary: Upload profile avatar
      description: Upload a profile picture (JPEG or PNG only, max 5MB). Content-Type is detected from file bytes to prevent spoofing. Requires authentication and CSRF token.
      operationId: userUploadAvatar
      security:
        - accessTokenCookie: []
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [avatar]
              properties:
                avatar:
                  type: string
                  format: binary
                  description: Avatar image file (JPEG or PNG, max 5MB)
      responses:
        '200':
          description: Avatar uploaded successfully
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    required: [object_key, avatar_url]
                    properties:
                      object_key:
                        type: string
                        description: MinIO object key for the uploaded avatar
                        example: avatars/user-123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
                      avatar_url:
                        type: string
                        format: uri
                        description: Presigned URL to access the avatar (valid for 15 minutes)
                        example: http://localhost:9000/avatars/user-123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg?X-Amz-Algorithm=...
        '400':
          description: Bad request (file too large, invalid content type, or missing file)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                fileTooLarge:
                  value:
                    success: false
                    error:
                      code: FILE_TOO_LARGE
                      message: file size exceeds 5MB limit
                invalidFileType:
                  value:
                    success: false
                    error:
                      code: INVALID_FILE_TYPE
                      message: invalid file type, only JPEG and PNG images are allowed
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '413':
          description: Request entity too large (body exceeds 6MB limit)
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags: [User]
      summary: Delete profile avatar
      description: Delete the current user's profile avatar from storage. Validates ownership before deletion.
      operationId: userDeleteAvatar
      security:
        - accessTokenCookie: []
      parameters:
        - in: header
          name: X-CSRF-Token
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [object_key]
              properties:
                object_key:
                  type: string
                  description: The MinIO object key of the avatar to delete
                  example: avatars/user-123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
      responses:
        '200':
          description: Avatar deleted successfully
          content:
            application/json:
              schema:
                type: object
                required: [success, data]
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    required: [object_key, deleted]
                    properties:
                      object_key:
                        type: string
                        description: The object key that was deleted
                        example: avatars/user-123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
                      deleted:
                        type: boolean
                        description: Deletion confirmation flag
                        example: true
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Forbidden - attempting to delete another user's avatar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error:
                  code: FORBIDDEN
                  message: you do not have permission to delete this avatar
        '500':
          $ref: '#/components/responses/InternalServerError'

  /admin/users:
    get:
      tags: [Admin]
      summary: List users
      description: Returns paginated users with optional filtering by email/status/role and validated sorting.
      operationId: adminListUsers
      security:
        - accessTokenCookie: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sort_by
          schema:
            type: string
            enum: [id, created_at, updated_at, email, name, status, last_login_at]
            default: created_at
        - in: query
          name: sort_order
          schema: { type: string, enum: [asc, desc], default: desc }
        - in: query
          name: email
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: role
          schema: { type: string }
      responses:
        '200':
          description: Users returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
              examples:
                users:
                  value:
                    success: true
                    data:
                      items:
                        - id: 42
                          email: admin@example.com
                          name: Admin User
                          avatar_url: https://cdn.example.com/avatars/42.png
                          status: active
                          last_login_at: "2026-02-09T09:58:32Z"
                          created_at: "2026-02-01T00:00:00Z"
                          updated_at: "2026-02-09T09:58:32Z"
                          roles:
                            - id: 1
                              name: admin
                              description: Platform administrators
                              created_at: "2026-02-01T00:00:00Z"
                              updated_at: "2026-02-01T00:00:00Z"
                      pagination:
                        page: 1
                        page_size: 20
                        total: 1
                        total_pages: 1
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/users/{id}/roles:
    patch:
      tags: [Admin]
      summary: Set roles for user
      description: Replaces a user's assigned roles with the provided role ID set.
      operationId: adminSetUserRoles
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          description: Numeric user ID.
          schema:
            type: integer
            format: uint64
            minimum: 1
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetUserRolesRequest'
            examples:
              updateUserRoles:
                value:
                  role_ids: [1, 2]
      responses:
        '200':
          description: Roles updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SetUserRolesResponse'
              examples:
                updated:
                  value:
                    success: true
                    data:
                      user_id: 42
                      role_ids: [1, 2]
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/ConflictError'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/roles:
    get:
      tags: [Admin]
      summary: List roles
      description: Returns paginated RBAC roles with optional name filter and validated sorting.
      operationId: adminListRoles
      security:
        - accessTokenCookie: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sort_by
          schema:
            type: string
            enum: [id, created_at, updated_at, name]
            default: created_at
        - in: query
          name: sort_order
          schema: { type: string, enum: [asc, desc], default: desc }
        - in: query
          name: name
          schema: { type: string }
        - in: header
          name: If-None-Match
          required: false
          schema: { type: string }
          description: Conditional request ETag previously returned by this endpoint.
      responses:
        '200':
          description: Roles returned
          headers:
            ETag:
              description: Strong validator for the role list payload.
              schema: { type: string }
            Cache-Control:
              description: Private conditional-cache directive.
              schema: { type: string, example: private, no-cache }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleListResponse'
              examples:
                roles:
                  value:
                    success: true
                    data:
                      items:
                        - id: 1
                          name: admin
                          description: Platform administrators
                          permissions:
                            - id: 1
                              resource: users
                              action: read
                              created_at: "2026-02-01T00:00:00Z"
                              updated_at: "2026-02-01T00:00:00Z"
                            - id: 2
                              resource: users
                              action: write
                              created_at: "2026-02-01T00:00:00Z"
                              updated_at: "2026-02-01T00:00:00Z"
                          created_at: "2026-02-01T00:00:00Z"
                          updated_at: "2026-02-01T00:00:00Z"
                      pagination:
                        page: 1
                        page_size: 20
                        total: 2
                        total_pages: 1
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '304':
          description: Not Modified (If-None-Match matched current ETag)
          headers:
            ETag:
              description: Current entity tag for the resource.
              schema: { type: string }
            Cache-Control:
              description: Private conditional-cache directive.
              schema: { type: string, example: private, no-cache }
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Admin]
      summary: Create role
      description: Creates a new role and optionally attaches permissions by `resource:action` strings.
      operationId: adminCreateRole
      security:
        - accessTokenCookie: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
            examples:
              createRole:
                value:
                  name: support_admin
                  description: Support operators with user management capabilities
                  permissions: [users:read, users:write]
      responses:
        '201':
          description: Role created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateRoleResponse'
              examples:
                created:
                  value:
                    success: true
                    data:
                      id: 7
                      name: support_admin
                      description: Support operators with user management capabilities
                      permissions: []
                      created_at: "2026-02-09T10:00:00Z"
                      updated_at: "2026-02-09T10:00:00Z"
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '400':
          description: Invalid input (including malformed permission format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
              examples:
                invalidPermissionFormat:
                  value:
                    success: false
                    error:
                      code: BAD_REQUEST
                      message: permission format must be resource:action
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
                duplicateRole:
                  value:
                    success: false
                    error:
                      code: BAD_REQUEST
                      message: failed to create role
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/ConflictError'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/permissions:
    get:
      tags: [Admin]
      summary: List permissions
      description: Returns paginated permission catalog with optional resource/action filters and validated sorting.
      operationId: adminListPermissions
      security:
        - accessTokenCookie: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
        - in: query
          name: page_size
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: sort_by
          schema:
            type: string
            enum: [id, created_at, updated_at, resource, action]
            default: created_at
        - in: query
          name: sort_order
          schema: { type: string, enum: [asc, desc], default: desc }
        - in: query
          name: resource
          schema: { type: string }
        - in: query
          name: action
          schema: { type: string }
        - in: header
          name: If-None-Match
          required: false
          schema: { type: string }
          description: Conditional request ETag previously returned by this endpoint.
      responses:
        '200':
          description: Permissions returned
          headers:
            ETag:
              description: Strong validator for the permission list payload.
              schema: { type: string }
            Cache-Control:
              description: Private conditional-cache directive.
              schema: { type: string, example: private, no-cache }
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PermissionListResponse'
              examples:
                permissions:
                  value:
                    success: true
                    data:
                      items:
                        - id: 1
                          resource: users
                          action: read
                          created_at: "2026-02-01T00:00:00Z"
                          updated_at: "2026-02-01T00:00:00Z"
                        - id: 2
                          resource: users
                          action: write
                          created_at: "2026-02-01T00:00:00Z"
                          updated_at: "2026-02-01T00:00:00Z"
                      pagination:
                        page: 1
                        page_size: 20
                        total: 6
                        total_pages: 1
                    meta:
                      request_id: req-abc123
                      timestamp: "2026-02-09T10:00:00Z"
        '304':
          description: Not Modified (If-None-Match matched current ETag)
          headers:
            ETag:
              description: Current entity tag for the resource.
              schema: { type: string }
            Cache-Control:
              description: Private conditional-cache directive.
              schema: { type: string, example: private, no-cache }
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags: [Admin]
      summary: Create permission
      description: Creates a permission using strict `resource:action` parts.
      operationId: adminCreatePermission
      security:
        - accessTokenCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePermissionRequest'
      responses:
        '201':
          description: Permission created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          description: Permission conflict.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/roles/{id}:
    patch:
      tags: [Admin]
      summary: Update role
      description: Updates role name/description and replaces permission bindings.
      operationId: adminUpdateRole
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateRoleResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Role conflict.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [Admin]
      summary: Delete role
      description: Deletes a role unless protected by server policy.
      operationId: adminDeleteRole
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      responses:
        '200':
          description: Role deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteRoleResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/permissions/{id}:
    patch:
      tags: [Admin]
      summary: Update permission
      description: Updates one permission and enforces protected/self-lockout constraints.
      operationId: adminUpdatePermission
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePermissionRequest'
      responses:
        '200':
          description: Permission updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '409':
          description: Permission conflict.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags: [Admin]
      summary: Delete permission
      description: Deletes a permission unless protected by policy.
      operationId: adminDeletePermission
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      responses:
        '200':
          description: Permission deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeletePermissionResponse'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /admin/rbac/sync:
    post:
      tags: [Admin]
      summary: Reconcile RBAC seed definitions
      description: Idempotently ensures default roles/permissions and bindings are present.
      operationId: adminSyncRBAC
      security:
        - accessTokenCookie: []
      responses:
        '200':
          description: Sync report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RBACSyncResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'

  /products:
    get:
      tags: [Products]
      summary: List products with pagination
      operationId: listProducts
      security:
        - accessTokenCookie: []
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            format: int32
            minimum: 1
            default: 1
        - in: query
          name: page_size
          schema:
            type: integer
            format: int32
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: Paginated products
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean, enum: [true] }
                  data:
                    type: object
                    required: [items, pagination]
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Product'
                      pagination:
                        type: object
                        required: [page, page_size, total, total_pages]
                        properties:
                          page: { type: integer, format: int32, minimum: 1 }
                          page_size: { type: integer, format: int32, minimum: 1, maximum: 100 }
                          total: { type: integer, format: int64, minimum: 0 }
                          total_pages: { type: integer, format: int32, minimum: 0 }
                  meta:
                    $ref: '#/components/schemas/Meta'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/InternalError'
    post:
      tags: [Products]
      summary: Create product
      operationId: createProduct
      security:
        - accessTokenCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreateRequest'
      responses:
        '201':
          description: Product created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '409':
          $ref: '#/components/responses/ConflictError'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}:
    get:
      tags: [Products]
      summary: Get product by ID
      operationId: getProductById
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      responses:
        '200':
          description: Product detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'
    put:
      tags: [Products]
      summary: Update product
      operationId: updateProduct
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductUpdateRequest'
      responses:
        '200':
          description: Product updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags: [Products]
      summary: Delete product
      operationId: deleteProduct
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
            format: uint64
            minimum: 1
      responses:
        '200':
          description: Product deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/InternalError'

  /feature-flags:
    get:
      tags: [User]
      summary: Evaluate all feature flags for current user context
      operationId: evaluateFeatureFlags
      security:
        - accessTokenCookie: []
      parameters:
        - in: query
          name: org
          schema: { type: string }
        - in: query
          name: environment
          schema: { type: string }
      responses:
        '200':
          description: Resolved feature flag values
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean, enum: [true] }
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/FeatureFlagEvaluation'
                  meta:
                    $ref: '#/components/schemas/Meta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /feature-flags/{key}:
    get:
      tags: [User]
      summary: Evaluate one feature flag key
      operationId: evaluateFeatureFlagByKey
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: key
          required: true
          schema:
            type: string
        - in: query
          name: org
          schema: { type: string }
        - in: query
          name: environment
          schema: { type: string }
      responses:
        '200':
          description: Resolved flag value
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean, enum: [true] }
                  data:
                    $ref: '#/components/schemas/FeatureFlagEvaluation'
                  meta:
                    $ref: '#/components/schemas/Meta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /admin/feature-flags:
    get:
      tags: [Admin]
      summary: List feature flags
      operationId: adminListFeatureFlags
      security:
        - accessTokenCookie: []
      responses:
        '200':
          description: Feature flag collection
          content:
            application/json:
              schema:
                type: object
                required: [success, data, meta]
                properties:
                  success: { type: boolean, enum: [true] }
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/FeatureFlag'
                  meta:
                    $ref: '#/components/schemas/Meta'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
    post:
      tags: [Admin]
      summary: Create feature flag
      operationId: adminCreateFeatureFlag
      security:
        - accessTokenCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureFlagCreateRequest'
      responses:
        '201':
          description: Feature flag created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /admin/feature-flags/{id}:
    get:
      tags: [Admin]
      summary: Get feature flag
      operationId: adminGetFeatureFlag
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      responses:
        '200':
          description: Feature flag detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    patch:
      tags: [Admin]
      summary: Update feature flag
      operationId: adminUpdateFeatureFlag
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureFlagUpdateRequest'
      responses:
        '200':
          description: Feature flag updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [Admin]
      summary: Delete feature flag
      operationId: adminDeleteFeatureFlag
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      responses:
        '200':
          description: Feature flag deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'

  /admin/feature-flags/{id}/rules:
    get:
      tags: [Admin]
      summary: List feature flag rules
      operationId: adminListFeatureFlagRules
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      responses:
        '200':
          description: Feature flag rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
    post:
      tags: [Admin]
      summary: Create feature flag rule
      operationId: adminCreateFeatureFlagRule
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureFlagRuleUpsertRequest'
      responses:
        '201':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'

  /admin/feature-flags/{id}/rules/{rule_id}:
    patch:
      tags: [Admin]
      summary: Update feature flag rule
      operationId: adminUpdateFeatureFlagRule
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
        - in: path
          name: rule_id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeatureFlagRuleUpsertRequest'
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '400':
          $ref: '#/components/responses/BadRequestError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
    delete:
      tags: [Admin]
      summary: Delete feature flag rule
      operationId: adminDeleteFeatureFlagRule
      security:
        - accessTokenCookie: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
        - in: path
          name: rule_id
          required: true
          schema: { type: integer, format: uint64, minimum: 1 }
      responses:
        '200':
          description: Rule deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Envelope'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
