#!/usr/bin/env bash
set -euo pipefail

staged_files="$(git diff --cached --name-only --diff-filter=ACMR)"
if [[ -n "${staged_files}" ]] && command -v pre-commit >/dev/null 2>&1; then
  echo "pre-commit: delegating to pre-commit framework"
  # shellcheck disable=SC2086
  exec pre-commit run --hook-stage pre-commit --files ${staged_files}
fi

staged_go_files="$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.go$' || true)"
if [[ -n "${staged_go_files}" ]]; then
  echo "pre-commit: formatting staged Go files"
  # shellcheck disable=SC2086
  gofmt -w ${staged_go_files}
  # shellcheck disable=SC2086
  git add ${staged_go_files}
fi

echo "pre-commit: syncing module files"
GOTOOLCHAIN=go1.26.0 go mod tidy
git add go.mod go.sum
