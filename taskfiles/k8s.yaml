version: "3"

vars:
  K8S_NAMESPACE: secure-observable
  KIND_CLUSTER_NAME: secure-observable
  API_IMAGE: secure-observable-api:dev

tasks:
  k8s:cluster-create:
    cmds:
      - KIND_CLUSTER_NAME={{.KIND_CLUSTER_NAME}} bash k8s/scripts/kind-setup.sh create

  k8s:cluster-delete:
    cmds:
      - KIND_CLUSTER_NAME={{.KIND_CLUSTER_NAME}} bash k8s/scripts/kind-setup.sh delete

  k8s:cluster-reset:
    cmds:
      - KIND_CLUSTER_NAME={{.KIND_CLUSTER_NAME}} bash k8s/scripts/kind-setup.sh reset

  k8s:cluster-status:
    cmds:
      - KIND_CLUSTER_NAME={{.KIND_CLUSTER_NAME}} bash k8s/scripts/kind-setup.sh status

  k8s:image-build:
    cmds:
      - docker build -t {{.API_IMAGE}} .

  k8s:image-load-kind:
    cmds:
      - kind load docker-image {{.API_IMAGE}} --name {{.KIND_CLUSTER_NAME}}

  k8s:image-build-load-kind:
    cmds:
      - task k8s:image-build
      - task k8s:image-load-kind

  k8s:secrets-generate:
    cmds:
      - bash k8s/scripts/setup-secrets.sh generate

  k8s:secrets-apply:
    cmds:
      - bash k8s/scripts/setup-secrets.sh apply

  k8s:secrets-encrypt:
    cmds:
      - bash k8s/scripts/secrets.sh encrypt

  k8s:deploy-base:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh base

  k8s:deploy-dev:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh development

  k8s:deploy-prod-like:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh prod-like

  k8s:deploy-staging:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh staging

  k8s:deploy-production:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh production


  k8s:deploy-observability:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh observability

  k8s:deploy-observability-dev:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh observability-dev

  k8s:deploy-observability-ci:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh observability-ci

  k8s:deploy-observability-prod-like:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh observability-prod-like

  k8s:deploy-observability-prod-like-ha:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/deploy.sh observability-prod-like-ha

  k8s:rollout:
    cmds:
      - kubectl -n {{.K8S_NAMESPACE}} rollout status statefulset/postgres
      - kubectl -n {{.K8S_NAMESPACE}} rollout status statefulset/redis
      - kubectl -n {{.K8S_NAMESPACE}} rollout status deployment/secure-observable-api

  k8s:status:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/status.sh

  k8s:obs-status:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/obs-status.sh

  k8s:obs-capacity-check:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/obs-capacity-check.sh

  k8s:logs-api:
    cmds:
      - kubectl -n {{.K8S_NAMESPACE}} logs deploy/secure-observable-api --tail=200

  k8s:port-forward-api:
    cmds:
      - kubectl -n {{.K8S_NAMESPACE}} port-forward svc/secure-observable-api 8080:8080

  k8s:port-forward-grafana:
    cmds:
      - kubectl -n {{.K8S_NAMESPACE}} port-forward svc/grafana 3000:3000

  k8s:health-check:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} bash k8s/scripts/health-check.sh

  k8s:cleanup:
    cmds:
      - K8S_NAMESPACE={{.K8S_NAMESPACE}} KIND_CLUSTER_NAME={{.KIND_CLUSTER_NAME}} bash k8s/scripts/cleanup.sh

  k8s:setup-full:
    cmds:
      - task k8s:cluster-create
      - task k8s:image-build-load-kind
      - task k8s:secrets-generate
      - task k8s:secrets-apply
      - task k8s:deploy-dev
      - task k8s:health-check
      - task k8s:status

  # Backward-compatible aliases
  k8s:kind-create:
    cmds:
      - task k8s:cluster-create

  k8s:kind-delete:
    cmds:
      - task k8s:cluster-delete

  k8s:validate-manifests:
    cmds:
      - bash scripts/ci/run_k8s_manifest_validate.sh

  k8s:policy-check:
    cmds:
      - bash scripts/ci/run_k8s_policy_check.sh

  k8s:validate-external-secrets:
    cmds:
      - bash scripts/ci/run_k8s_external_secrets_validate.sh

  k8s:validate-secret-stores:
    cmds:
      - bash scripts/ci/run_k8s_secret_stores_validate.sh

  k8s:apply-external-secrets-dev:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/external-secrets/dev

  k8s:apply-external-secrets-staging:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/external-secrets/staging

  k8s:apply-external-secrets-prod:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/external-secrets/prod

  k8s:apply-secret-store-aws-irsa:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/stores/aws-irsa

  k8s:apply-secret-store-aws-static:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/stores/aws-static

  k8s:apply-secret-store-vault-kubernetes:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/stores/vault-kubernetes

  k8s:apply-secret-store-vault-token:
    cmds:
      - kubectl apply -k k8s/overlays/secrets/stores/vault-token

  # Compatibility aliases
  k8s:apply-secret-store-aws:
    cmds:
      - task k8s:apply-secret-store-aws-irsa

  k8s:apply-secret-store-vault:
    cmds:
      - task k8s:apply-secret-store-vault-kubernetes
