version: '3'

tasks:
  lint:tools:
    cmds:
      - mkdir -p ./bin
      - GOBIN=$(pwd)/bin GOTOOLCHAIN=go1.25.4 go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.5.0

  wire:
    cmds:
      - go run -mod=mod github.com/google/wire/cmd/wire ./internal/di

  wire-check:
    cmds:
      - task wire
      - GOTOOLCHAIN=go1.24.13 go mod tidy
      - git diff --exit-code internal/di/wire_gen.go go.mod go.sum

  tidy-check:
    cmds:
      - GOTOOLCHAIN=go1.24.13 go mod tidy
      - git diff --exit-code go.mod go.sum

  test:
    cmds:
      - go test ./...

  test:auth-lifecycle:
    cmds:
      - go test ./test/integration -run TestAuthLifecycle -v

  test:session-management:
    cmds:
      - go test ./test/integration -run TestSessionManagement -v

  test:email-verification:
    cmds:
      - go test ./test/integration -run TestEmailVerification -v

  test:password-reset:
    cmds:
      - go test ./test/integration -run TestPasswordReset -v

  test:admin-rbac-write:
    cmds:
      - go test ./test/integration -run TestAdminRBAC -v

  test:admin-list:
    cmds:
      - go test ./test/integration -run TestAdminList -v

  test:problem-details:
    cmds:
      - go test ./test/integration -run TestProblemDetails -v

  test:idempotency:
    cmds:
      - go test ./test/integration -run TestIdempotency -v

  test:audit:
    cmds:
      - go test ./internal/observability -run TestBuildAuditEvent -v
      - go test ./test/integration -run TestAuditTaxonomy -v

  lint:
    deps: [lint:tools]
    cmds:
      - GOTOOLCHAIN=go1.25.4 ./bin/golangci-lint run --config .golangci.yml

  cli:smoke:
    cmds:
      - go run ./cmd/migrate --help >/dev/null
      - go run ./cmd/seed --help >/dev/null
      - go run ./cmd/loadgen --help >/dev/null
      - go run ./cmd/obscheck --help >/dev/null
