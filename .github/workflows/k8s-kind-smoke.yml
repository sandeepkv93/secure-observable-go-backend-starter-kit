name: k8s-kind-smoke

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'k8s/**'
      - 'taskfiles/k8s.yaml'
      - 'Taskfile.yaml'
      - 'Dockerfile'
      - '.github/workflows/k8s-kind-smoke.yml'
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - 'taskfiles/k8s.yaml'
      - 'Taskfile.yaml'
      - 'Dockerfile'
      - '.github/workflows/k8s-kind-smoke.yml'

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Task
        uses: arduino/setup-task@v2

      - name: Install kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version

      - name: Install kubectl argo rollouts plugin
        env:
          ARGO_ROLLOUTS_VERSION: v1.7.2
        run: |
          curl -sSL "https://github.com/argoproj/argo-rollouts/releases/download/${ARGO_ROLLOUTS_VERSION}/kubectl-argo-rollouts-linux-amd64" -o /tmp/kubectl-argo-rollouts
          chmod +x /tmp/kubectl-argo-rollouts
          sudo mv /tmp/kubectl-argo-rollouts /usr/local/bin/kubectl-argo-rollouts
          kubectl argo rollouts version

      - name: Prepare local k8s secrets env
        run: |
          cat > .secrets.k8s.app.env <<'SECRETS'
          DB_PASSWORD=app
          DATABASE_URL=postgres://app:app@postgres:5432/app?sslmode=disable
          JWT_ACCESS_SECRET=12345678901234567890123456789012
          JWT_REFRESH_SECRET=12345678901234567890123456789013
          REFRESH_TOKEN_PEPPER=1234567890abcdef
          OAUTH_STATE_SECRET=1234567890abcdef
          GOOGLE_OAUTH_CLIENT_ID=
          GOOGLE_OAUTH_CLIENT_SECRET=
          GOOGLE_OAUTH_REDIRECT_URL=
          REDIS_PASSWORD=app
          SECRETS

      - name: Bring up kind + k8s dev overlay
        run: task k8s:setup-full

      - name: Health checks
        run: task k8s:health-check

      - name: Runtime rollout precheck with traffic + SLO evidence
        env:
          EVIDENCE_DIR: .artifacts/k8s-rollout-evidence
          ROLLOUT_ENV: staging
        run: bash scripts/ci/run_k8s_rollout_runtime_kind.sh

      - name: Upload rollout evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k8s-rollout-evidence
          path: .artifacts/k8s-rollout-evidence
          if-no-files-found: warn

      - name: Cluster status on failure
        if: failure()
        run: |
          task k8s:status || true
          task k8s:obs-status || true
          kubectl -n secure-observable get rollout secure-observable-api -o yaml || true
          kubectl -n argo-rollouts get deploy,pods || true

      - name: Cleanup
        if: always()
        run: |
          task k8s:cleanup || true
          task k8s:cluster-delete || true
