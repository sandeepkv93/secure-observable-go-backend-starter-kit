name: ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  k8s-manifest-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install kustomize
        env:
          KUSTOMIZE_VERSION: v5.4.2
        run: |
          curl -sSL "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz" -o /tmp/kustomize.tgz
          tar -xzf /tmp/kustomize.tgz -C /tmp
          sudo mv /tmp/kustomize /usr/local/bin/kustomize
          kustomize version

      - name: Install kubeconform
        env:
          KUBECONFORM_VERSION: v0.6.7
        run: |
          curl -sSL "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz" -o /tmp/kubeconform.tgz
          tar -xzf /tmp/kubeconform.tgz -C /tmp kubeconform
          sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      - name: Install conftest
        env:
          CONFTEST_VERSION: v0.59.0
        run: |
          curl -sSL "https://github.com/open-policy-agent/conftest/releases/download/${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION#v}_Linux_x86_64.tar.gz" -o /tmp/conftest.tgz
          tar -xzf /tmp/conftest.tgz -C /tmp conftest
          sudo mv /tmp/conftest /usr/local/bin/conftest
          conftest --version

      - name: Validate Grafana dashboard generation
        run: bash scripts/ci/run_grafana_dashboards_generate_check.sh

      - name: Validate k8s manifests
        run: bash scripts/ci/run_k8s_manifest_validate.sh

      - name: OPA policy checks
        run: bash scripts/ci/run_k8s_policy_check.sh

      - name: Validate external secrets overlay
        run: bash scripts/ci/run_k8s_external_secrets_validate.sh

      - name: Validate secret store overlays
        run: bash scripts/ci/run_k8s_secret_stores_validate.sh

      - name: Validate rollout overlay policy
        run: bash scripts/ci/run_k8s_rollout_validate.sh

      - name: Validate rollout precheck script
        run: bash scripts/ci/run_k8s_rollout_precheck_script_check.sh

      - name: Validate rollout runtime kind script
        run: bash scripts/ci/run_k8s_rollout_runtime_script_check.sh

      - name: Validate availability profiles policy
        run: bash scripts/ci/run_k8s_availability_validate.sh

      - name: Validate observability alert check script
        run: bash scripts/ci/run_k8s_obs_alert_script_check.sh

  fuzz-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run fuzz smoke suite
        env:
          FUZZ_SMOKE_TIME: 3s
        run: bash scripts/ci/run_fuzz_smoke.sh

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install pre-commit tooling
        run: python -m pip install --upgrade pip pre-commit
      - name: Run pre-commit checks
        run: pre-commit run --all-files
      - name: Set up Bazelisk
        uses: bazelbuild/setup-bazelisk@v3
      - name: Run direct CI checks
        run: bash scripts/ci/run_all.sh

  integration-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run avatar MinIO integration smoke
        run: go test ./test/integration -run TestAvatar -count=1

  migration-smoke:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: starterkit
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d starterkit"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      APP_ENV: test
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/starterkit?sslmode=disable
      JWT_ACCESS_SECRET: "12345678901234567890123456789012"
      JWT_REFRESH_SECRET: "12345678901234567890123456789013"
      REFRESH_TOKEN_PEPPER: "1234567890abcdef"
      OAUTH_STATE_SECRET: "1234567890abcdef"
      AUTH_GOOGLE_ENABLED: "false"
      AUTH_LOCAL_ENABLED: "true"
      RATE_LIMIT_REDIS_ENABLED: "false"
      OTEL_METRICS_ENABLED: "false"
      OTEL_TRACING_ENABLED: "false"
      OTEL_LOGS_ENABLED: "false"
      OTEL_LOG_LEVEL: info
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Migration smoke tests
        run: bash scripts/ci/run_migration_smoke.sh
