sequenceDiagram
    participant C as Client
    participant R as Router
    participant RL as API Rate Limiter
    participant JWT as JWT Manager
    participant B as Limiter Backend (Redis/Local)
    participant H as Handler

    C->>R: Request /api/v1/*
    R->>RL: Apply global limiter middleware
    RL->>JWT: Parse access token (cookie/bearer)
    alt valid access token with subject
        RL->>RL: key = sub:<user_id>
    else missing/invalid token
        RL->>RL: key = client_ip
    end

    RL->>B: Allow(key, limit, window)
    alt allowed
        RL->>H: Continue request
        H-->>C: 2xx/4xx/5xx (+ X-RateLimit-*)
    else denied
        RL-->>C: 429 RATE_LIMITED (Retry-After + X-RateLimit-*)
    end
